terraform {
  required_version = ">= 1.0"
  required_providers {
    aws = {
      source  = "hashicorp/aws"
      version = "~> 5.0"
    }
    kubernetes = {
      source  = "hashicorp/kubernetes"
      version = "~> 2.0"
    }
    helm = {
      source  = "hashicorp/helm"
      version = "~> 2.0"
    }
  }
}

provider "aws" {
  region = local.aws_region
}

provider "kubernetes" {
  host                   = "https://7590C00AADB3A5465C90C53F780E614E.gr7.eu-west-1.eks.amazonaws.com"
  cluster_ca_certificate = base64decode("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJUCtBYnoxOUZIZVV3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBNE1qRXlNVEF4TXpOYUZ3MHpOVEE0TVRreU1UQTJNek5hTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUNYQThvVmJhODhPYUM5SnBnY3VzWW13ZFRPeDhIUTlNa1hQQlhDNzFmcmc1UlBwUkhpNFVSRHQwRVoKaE9jWFQ0S0VBcmI4b1hCZ0hZSXgwMlpCVWRLZTJBRUR3Y3NOZDFYbXpnOFJodDBBSWxIeDFqOUxxalkzdG5icgprUWR4MUN6ZldGdWlqcm5uTWNFL0tiejF3L2V4ZlU4S01kTlR0VHhiWGc5RFBNTzUrNVJXZTd2U0dBTHxlUFdQCm9HeUcvbjVBWDFrUnR3UWsrTkl4OCttbmVNclV4ZEtJT245UHpLb091aHNaSDhOVWFmNDFhWHA0K0JLR0JuZU4KRTJCczZ0K0tJRE5oVTJFUVAxLzZUelhabDlYbkhHQlFtRWo0RHFQcjQ1d050a1VMQ3ZwNTYwS2RDazJSY1d6awpMTi9vVGZqcUF5UnN3RlNqbmhpT2JBbWxWVG5oQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRakc2WnRzdjArUkVaZUh0SVpUU1RnUStoc0dUQVYKQmdOVkhSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUV4cWJ3cnMvdApBUHk5eTFTb1I5MHZiRzNnb3FmeGpCWEw1MWZLRkhpa2c1RzErZ3phZU5OY1BtNmJFb09NUUVlYWxFY1FHZ2xICnFZa3RzMkFldkxWOTFoVGJzZFJlakZZa2x2OGVUMVpER3BzZHorQWFZMi9MTnF6d1RNYjdENk1Jd3d3dFA5RnIKR0t6a3dDQUVpUXA5NDc1RTVaTnZ6ZVkyVkdGOVNSTVkvNDdhWDUrK0hIdVFia1FVdEhnNXlvaVR2Y01iRXhHRQord2s2eFV5M0RGNmVteXVPR2NsMyt4RWZjYkY0STlnT3hLTWJsRWZwa0pRdzVEenZITFh0TGtMZXFpakNvb1FyCmtQV0d1UFlEeHkxZnRUSFgvSWtSeW9iZnBzbU9SaTRjUzV6UzRPRWJuaU9VWEgxcTRvOWtlZ05aTG84anBpYUkKWEVNMmJDdmsvczltCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K")
  exec {
    api_version = "client.authentication.k8s.io/v1beta1"
    command     = "aws"
    args        = ["eks", "get-token", "--cluster-name", "eks-cluster", "--region", "eu-west-1"]
  }
}

provider "helm" {
  kubernetes {
    host                   = "https://7590C00AADB3A5465C90C53F780E614E.gr7.eu-west-1.eks.amazonaws.com"
    cluster_ca_certificate = base64decode("LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSURCVENDQWUyZ0F3SUJBZ0lJUCtBYnoxOUZIZVV3RFFZSktvWklodmNOQVFFTEJRQXdGVEVUTUJFR0ExVUUKQXhNS2EzVmlaWEp1WlhSbGN6QWVGdzB5TlRBNE1qRXlNVEF4TXpOYUZ3MHpOVEE0TVRreU1UQTJNek5hTUJVeApFekFSQmdOVkJBTVRDbXQxWW1WeWJtVjBaWE13Z2dFaU1BMEdDU3FHU0liM0RRRUJBUVVBQTRJQkR3QXdnZ0VLCkFvSUJBUUNYQThvVmJhODhPYUM5SnBnY3VzWW13ZFRPeDhIUTlNa1hQQlhDNzFmcmc1UlBwUkhpNFVSRHQwRVoKaE9jWFQ0S0VBcmI4b1hCZ0hZSXgwMlpCVWRLZTJBRUR3Y3NOZDFYbXpnOFJodDBBSWxIeDFqOUxxalkzdG5icgprUWR4MUN6ZldGdWlqcm5uTWNFL0tiejF3L2V4ZlU4S01kTlR0VHhiWGc5RFBNTzUrNVJXZTd2U0dBTHxlUFdQCm9HeUcvbjVBWDFrUnR3UWsrTkl4OCttbmVNclV4ZEtJT245UHpLb091aHNaSDhOVWFmNDFhWHA0K0JLR0JuZU4KRTJCczZ0K0tJRE5oVTJFUVAxLzZUelhabDlYbkhHQlFtRWo0RHFQcjQ1d050a1VMQ3ZwNTYwS2RDazJSY1d6awpMTi9vVGZqcUF5UnN3RlNqbmhpT2JBbWxWVG5oQWdNQkFBR2pXVEJYTUE0R0ExVWREd0VCL3dRRUF3SUNwREFQCkJnTlZIUk1CQWY4RUJUQURBUUgvTUIwR0ExVWREZ1FXQkJRakc2WnRzdjArUkVaZUh0SVpUU1RnUStoc0dUQVYKQmdOVkhSRUVEakFNZ2dwcmRXklSRUVEakFNZ2dwcmRXSmxjbTVsZEdWek1BMEdDU3FHU0liM0RRRUJDd1VBQTRJQkFRQUV4cWJ3cnMvdApBUHk5eTFTb1I5MHZiRzNnb3FmeGpCWEw1MWZLRkhpa2c1RzErZ3phZU5OY1BtNmJFb09NUUVlYWxFY1FHZ2xICnFZa3RzMkFldkxWOTFoVGJzZFJlakZZa2x2OGVUMVpER3BzZHorQWFZMi9MTnF6d1RNYjdENk1Jd3d3dFA5RnIKR0t6a3dDQUVpUXA5NDc1RTVaTnZ6ZVkyVkdGOVNSTVkvNDdhWDUrK0hIdVFia1FVdEhnNXlvaVR2Y01iRXhHRQord2s2eFV5M0RGNmVteXVPR2NsMyt4RWZjYkY0STlnT3hLTWJsRWZwa0pRdzVEenZITFh0TGtMZXFpakNvb1FyCmtQV0d1UFlEeHkxZnRUSFgvSWtSeW9iZnBzbU9SaTRjUzV6UzRPRWJuaU9VWEgxcTRvOWtlZ05aTG84anBpYUkKWEVNMmJDdmsvczltCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0K")
    exec {
      api_version = "client.authentication.k8s.io/v1beta1"
      command     = "aws"
      args        = ["eks", "get-token", "--cluster-name", "eks-cluster", "--region", "eu-west-1"]
    }
  }
}
